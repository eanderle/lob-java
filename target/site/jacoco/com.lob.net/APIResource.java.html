<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>APIResource.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">lob-java</a> &gt; <a href="index.source.html" class="el_package">com.lob.net</a> &gt; <span class="el_source">APIResource.java</span></div><h1>APIResource.java</h1><pre class="source lang-java linenums">package com.lob.net;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.UnsupportedEncodingException;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.URLEncoder;
import java.util.HashMap;
import java.util.Map;
import java.util.Scanner;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.mime.HttpMultipartMode;
import org.apache.http.entity.mime.MultipartEntityBuilder;
import org.apache.http.impl.client.HttpClientBuilder;

import com.google.gson.FieldNamingPolicy;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.lob.Lob;
import com.lob.exception.APIConnectionException;
import com.lob.exception.APIException;
import com.lob.exception.AuthenticationException;
import com.lob.exception.InvalidRequestException;
import com.lob.model.EventData;
import com.lob.model.EventDataDeserializer;
import com.lob.model.LobObject;
import com.lob.model.LobRawJsonObject;
import com.lob.model.LobRawJsonObjectDeserializer;

<span class="nc" id="L38">public abstract class APIResource extends LobObject {</span>

<span class="nc" id="L40">	public static final Gson gson = new GsonBuilder()</span>
			.setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES)
			.registerTypeAdapter(EventData.class, new EventDataDeserializer())
			.registerTypeAdapter(LobRawJsonObject.class, new LobRawJsonObjectDeserializer())
			.create();

	private static String className(Class&lt;?&gt; clazz) {
<span class="nc" id="L47">		return clazz.getSimpleName().toLowerCase().replace(&quot;$&quot;, &quot;&quot;);</span>
	}

	protected static String singleClassURL(Class&lt;?&gt; clazz) {
<span class="nc bnc" id="L51" title="All 2 branches missed.">		if (className(clazz).contains(&quot;country&quot;))</span>
<span class="nc" id="L52">			return String.format(&quot;%s/v1/countrie&quot;, Lob.API_BASE, className(clazz));</span>
		else
<span class="nc" id="L54">			return String.format(&quot;%s/v1/%s&quot;, Lob.API_BASE, className(clazz));</span>
	}
	

	protected static String classURL(Class&lt;?&gt; clazz) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (className(clazz).contains(&quot;address&quot;))</span>
<span class="nc" id="L60">			return String.format(&quot;%ses&quot;, singleClassURL(clazz));</span>
		else
<span class="nc" id="L62">			return String.format(&quot;%ss&quot;, singleClassURL(clazz));	</span>
	}

	protected static String instanceURL(Class&lt;?&gt; clazz, String id) {
<span class="nc" id="L66">		return String.format(&quot;%s/%s&quot;, classURL(clazz), id);</span>
	}

	public static final String CHARSET = &quot;UTF-8&quot;;

	private static final String DNS_CACHE_TTL_PROPERTY_NAME = &quot;networkaddress.cache.ttl&quot;;

<span class="nc" id="L73">	protected enum RequestMethod {</span>
<span class="nc" id="L74">		GET, POST, DELETE</span>
	}

	private static String urlEncodePair(String k, String v)
			throws UnsupportedEncodingException {
<span class="nc" id="L79">		return String.format(&quot;%s=%s&quot;, URLEncoder.encode(k, CHARSET),</span>
				URLEncoder.encode(v, CHARSET));
	}

	static Map&lt;String, String&gt; getHeaders(String apiKey) {
<span class="nc" id="L84">		Map&lt;String, String&gt; headers = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L85">		headers.put(&quot;Accept-Charset&quot;, CHARSET);</span>
<span class="nc" id="L86">		headers.put(&quot;User-Agent&quot;,</span>
				String.format(&quot;Lob/v1 JavaBindings/%s&quot;, Lob.VERSION));

<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (apiKey == null) {</span>
<span class="nc" id="L90">			apiKey = Lob.apiKey;</span>
		}

<span class="nc" id="L93">		headers.put(&quot;Authorization&quot;, &quot;Basic &quot; + apiKey);</span>

		// debug headers
/*		String[] propertyNames = { &quot;os.name&quot;, &quot;os.version&quot;, &quot;os.arch&quot;,
				&quot;java.version&quot;, &quot;java.vendor&quot;, &quot;java.vm.version&quot;,
				&quot;java.vm.vendor&quot; };
		Map&lt;String, String&gt; propertyMap = new HashMap&lt;String, String&gt;();
		for (String propertyName : propertyNames) {
			propertyMap.put(propertyName, System.getProperty(propertyName));
		}
		propertyMap.put(&quot;bindings.version&quot;, Lob.VERSION);
		propertyMap.put(&quot;lang&quot;, &quot;Java&quot;);
		propertyMap.put(&quot;publisher&quot;, &quot;Lob&quot;);
		headers.put(&quot;X-Lob-Client-User-Agent&quot;, gson.toJson(propertyMap));
		if (Lob.apiVersion != null) {
			headers.put(&quot;Lob-Version&quot;, Lob.apiVersion);
		}
<span class="nc" id="L110">*/		return headers;</span>
	}

	private static javax.net.ssl.HttpsURLConnection createLobConnection(
			String url, String apiKey) throws IOException {
<span class="nc" id="L115">		URL lobURL = new URL(url);</span>

<span class="nc" id="L117">		javax.net.ssl.HttpsURLConnection conn = (javax.net.ssl.HttpsURLConnection) lobURL</span>
				.openConnection(); // enforce
									// SSL
									// URLs
<span class="nc" id="L121">		conn.setConnectTimeout(30000); // 30 seconds</span>
<span class="nc" id="L122">		conn.setReadTimeout(80000); // 80 seconds</span>
<span class="nc" id="L123">		conn.setUseCaches(false);</span>
		
<span class="nc bnc" id="L125" title="All 2 branches missed.">		if (!apiKey.endsWith(&quot;:&quot;))</span>
<span class="nc" id="L126">			apiKey = apiKey + &quot;:&quot;;</span>
		
<span class="nc" id="L128">		byte[] authEncBytes = org.apache.commons.codec.binary.Base64.encodeBase64(apiKey.getBytes());</span>
<span class="nc" id="L129">		String authStringEnc = new String(authEncBytes);</span>
		
<span class="nc" id="L131">		conn.setRequestProperty(&quot;Authorization&quot;, &quot;Basic &quot; + authStringEnc);</span>

<span class="nc" id="L133">		return conn;</span>
	}

	private static javax.net.ssl.HttpsURLConnection createGetConnection(
			String url, String query, String apiKey) throws IOException {
		String getURL;
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (query != &quot;&quot;)</span>
<span class="nc" id="L140">			getURL = String.format(&quot;%s?%s&quot;, url, query);</span>
		else
<span class="nc" id="L142">			getURL = url;</span>
		
<span class="nc" id="L144">		javax.net.ssl.HttpsURLConnection conn = createLobConnection(getURL,</span>
				apiKey);
<span class="nc" id="L146">		conn.setRequestMethod(&quot;GET&quot;);</span>
<span class="nc" id="L147">		return conn;</span>
	}

	private static HttpResponse createPostConnection(
			String url, String query, String apiKey, Map&lt;String, Object&gt; params) throws IOException {

<span class="nc" id="L153">	    HttpClient httpclient = HttpClientBuilder.create().build();</span>
<span class="nc" id="L154">	    HttpPost httppost = new HttpPost(url);</span>

		try {
<span class="nc" id="L157">	        MultipartEntityBuilder builder = MultipartEntityBuilder.create();        </span>
<span class="nc" id="L158">	        builder.setMode(HttpMultipartMode.BROWSER_COMPATIBLE);</span>

<span class="nc" id="L160">			Map&lt;String, String&gt; flatParams = flattenParams(params);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">			for (Map.Entry&lt;String, String&gt; entry : flatParams.entrySet()) {</span>
<span class="nc" id="L162">				String val = entry.getValue();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">				if (val.startsWith(&quot;@&quot;))</span>
				{
<span class="nc" id="L165">				    String filename = val.substring(1);</span>
<span class="nc" id="L166">				    java.io.File file = new java.io.File(filename);</span>
				       
<span class="nc" id="L168">				    java.io.FileInputStream fis = new java.io.FileInputStream(file);		    </span>
<span class="nc" id="L169">				    java.io.ByteArrayOutputStream bos = new java.io.ByteArrayOutputStream();</span>
<span class="nc" id="L170">			        byte[] buf = new byte[1024];</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">			        for (int readNum; (readNum = fis.read(buf)) != -1;) {</span>
<span class="nc" id="L173">			        	bos.write(buf, 0, readNum); //no doubt here is 0</span>
			                //Writes len bytes from the specified byte array starting at offset off to this byte array output stream.
			                //System.out.println(&quot;read &quot; + readNum + &quot; bytes,&quot;);
			        }

<span class="nc" id="L178">			        org.apache.http.entity.mime.content.ContentBody contentPart = </span>
			        	new org.apache.http.entity.mime.content.ByteArrayBody(bos.toByteArray(), filename);	
			        
<span class="nc" id="L181">			        builder.addPart(entry.getKey(), contentPart);</span>
<span class="nc" id="L182">				}</span>
				else
<span class="nc" id="L184">					builder.addTextBody(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L185">			}</span>
	        
<span class="nc" id="L187">	        HttpEntity yourEntity = builder.build();</span>
<span class="nc" id="L188">	        httppost.setEntity(yourEntity);</span>
	        
<span class="nc" id="L190">	        httppost.addHeader(&quot;User-Agent&quot;,</span>
	    			String.format(&quot;Lob/v1 JavaBindings/%s&quot;, Lob.VERSION));    

<span class="nc" id="L193">	    	byte[] authEncBytes = org.apache.commons.codec.binary.Base64.encodeBase64(Lob.apiKey.getBytes());</span>
<span class="nc" id="L194">	    	String authStringEnc = new String(authEncBytes);</span>
<span class="nc" id="L195">	        httppost.addHeader(&quot;Authorization&quot;, &quot;Basic &quot; + authStringEnc);</span>
	    	
<span class="nc" id="L197">	        HttpResponse response = httpclient.execute(httppost);</span>
<span class="nc" id="L198">	        return response;</span>
 
		}
<span class="nc" id="L201">	    catch (InvalidRequestException e)</span>
	    {
<span class="nc" id="L203">			throw new IOException(e);</span>
		}
	}

	private static javax.net.ssl.HttpsURLConnection createDeleteConnection(
			String url, String query, String apiKey) throws IOException {
<span class="nc" id="L209">		String deleteUrl = String.format(&quot;%s?%s&quot;, url, query);</span>
<span class="nc" id="L210">		javax.net.ssl.HttpsURLConnection conn = createLobConnection(</span>
				deleteUrl, apiKey);
<span class="nc" id="L212">		conn.setRequestMethod(&quot;DELETE&quot;);</span>
<span class="nc" id="L213">		return conn;</span>
	}

	private static String createQuery(Map&lt;String, Object&gt; params)
	    throws UnsupportedEncodingException, InvalidRequestException {
<span class="nc" id="L218">		Map&lt;String, String&gt; flatParams = flattenParams(params);</span>
<span class="nc" id="L219">		StringBuffer queryStringBuffer = new StringBuffer();</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">		for (Map.Entry&lt;String, String&gt; entry : flatParams.entrySet()) {</span>
<span class="nc" id="L221">			queryStringBuffer.append(&quot;&amp;&quot;);</span>
<span class="nc" id="L222">			queryStringBuffer.append(urlEncodePair(entry.getKey(),</span>
					entry.getValue()));
		}
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (queryStringBuffer.length() &gt; 0) {</span>
<span class="nc" id="L226">			queryStringBuffer.deleteCharAt(0);</span>
		}
<span class="nc" id="L228">		return queryStringBuffer.toString();</span>
	}

	private static Map&lt;String, String&gt; flattenParams(Map&lt;String, Object&gt; params)
			throws InvalidRequestException {
<span class="nc bnc" id="L233" title="All 2 branches missed.">		if (params == null) {</span>
<span class="nc" id="L234">			return new HashMap&lt;String, String&gt;();</span>
		}
<span class="nc" id="L236">		Map&lt;String, String&gt; flatParams = new HashMap&lt;String, String&gt;();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">		for (Map.Entry&lt;String, Object&gt; entry : params.entrySet()) {</span>
<span class="nc" id="L238">			String key = entry.getKey();</span>
<span class="nc" id="L239">			Object value = entry.getValue();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (value instanceof Map&lt;?, ?&gt;) {</span>
<span class="nc" id="L241">				Map&lt;String, Object&gt; flatNestedMap = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L242">				Map&lt;?, ?&gt; nestedMap = (Map&lt;?, ?&gt;) value;</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">				for (Map.Entry&lt;?, ?&gt; nestedEntry : nestedMap.entrySet()) {</span>
<span class="nc" id="L244">					flatNestedMap.put(</span>
							String.format(&quot;%s[%s]&quot;, key, nestedEntry.getKey()),
							nestedEntry.getValue());
				}
<span class="nc" id="L248">				flatParams.putAll(flattenParams(flatNestedMap));</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">			} else if (&quot;&quot;.equals(value)) {</span>
<span class="nc" id="L250">			    throw new InvalidRequestException(&quot;You cannot set '&quot;+key+&quot;' to an empty string. &quot;+</span>
							      &quot;We interpret empty strings as null in requests. &quot;+
							      &quot;You may set '&quot;+key+&quot;' to null to delete the property.&quot;,
							      key, null);
<span class="nc bnc" id="L254" title="All 2 branches missed.">			} else if (value == null) {</span>
<span class="nc" id="L255">				flatParams.put(key, &quot;&quot;);</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">			} else if (value != null) {</span>
<span class="nc" id="L257">				flatParams.put(key, value.toString());</span>
			}
<span class="nc" id="L259">		}</span>
<span class="nc" id="L260">		return flatParams;</span>
	}

	// represents Errors returned as JSON
<span class="nc" id="L264">	private static class ErrorContainer {</span>
		private APIResource.Error error;
	}

<span class="nc" id="L268">	private static class Error {</span>
		String type;

		String message;

		String code;

		String param;
	}

	private static String getResponseBody(InputStream responseStream)
			throws IOException {
<span class="nc" id="L280">		String rBody = new Scanner(responseStream, CHARSET).useDelimiter(&quot;\\A&quot;)</span>
				.next(); // \A is the beginning of
							// the stream boundary
<span class="nc" id="L283">		responseStream.close();</span>
<span class="nc" id="L284">		return rBody;</span>
	}

	private static LobResponse makeURLConnectionRequest(
			APIResource.RequestMethod method, String url, String query,
			String apiKey, Map&lt;String, Object&gt; params) throws APIConnectionException {
<span class="nc" id="L290">		javax.net.ssl.HttpsURLConnection conn = null;</span>
		try {
<span class="nc bnc" id="L292" title="All 4 branches missed.">			switch (method) {</span>
			case GET:
<span class="nc" id="L294">				conn = createGetConnection(url, query, apiKey);</span>
<span class="nc" id="L295">				break;</span>
			case POST:
<span class="nc" id="L297">				HttpResponse response = createPostConnection(url, query, apiKey, params);</span>
		        
<span class="nc" id="L299">				int rCode = response.getStatusLine().getStatusCode(); </span>
<span class="nc" id="L300">				String rBody = null;</span>
<span class="nc bnc" id="L301" title="All 4 branches missed.">				if (rCode &gt;= 200 &amp;&amp; rCode &lt; 300) {</span>
<span class="nc" id="L302">					rBody = getResponseBody(response.getEntity().getContent());</span>
				} else {
<span class="nc" id="L304">					rBody = getResponseBody(response.getEntity().getContent());</span>
				}
<span class="nc" id="L306">				return new LobResponse(rCode, rBody);</span>
				
			case DELETE:
<span class="nc" id="L309">				conn = createDeleteConnection(url, query, apiKey);</span>
<span class="nc" id="L310">				break;</span>
			default:
<span class="nc" id="L312">				throw new APIConnectionException(</span>
						String.format(
								&quot;Unrecognized HTTP method %s. &quot;
										+ &quot;This indicates a bug in the Lob bindings. Please contact &quot;
										+ &quot;support@lob.com for assistance.&quot;,
								method));
			}
<span class="nc" id="L319">			int rCode = conn.getResponseCode(); // triggers the request</span>
<span class="nc" id="L320">			String rBody = null;</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">			if (rCode &gt;= 200 &amp;&amp; rCode &lt; 300) {</span>
<span class="nc" id="L322">				rBody = getResponseBody(conn.getInputStream());</span>
			} else {
<span class="nc" id="L324">				rBody = getResponseBody(conn.getErrorStream());</span>
			}
<span class="nc" id="L326">			return new LobResponse(rCode, rBody);</span>
<span class="nc" id="L327">		} catch (IOException e) {</span>
<span class="nc" id="L328">			throw new APIConnectionException(</span>
					String.format(
							&quot;Could not connect to Lob (%s). &quot;
									+ &quot;Please check your internet connection and try again. If this problem persists,&quot;
									+ &quot;you should check Lob's service status at https://twitter.com/lobstatus,&quot;
									+ &quot; or let us know at support@lob.com.&quot;,
							Lob.API_BASE), e);
		} finally {
<span class="nc bnc" id="L336" title="All 6 branches missed.">			if (conn != null) {</span>
<span class="nc" id="L337">				conn.disconnect();</span>
			}
		}
	}

	protected static &lt;T&gt; T request(APIResource.RequestMethod method,
			String url, Map&lt;String, Object&gt; params, Class&lt;T&gt; clazz,
			String apiKey) throws AuthenticationException,
			InvalidRequestException, APIConnectionException, 
			APIException {
<span class="nc" id="L347">		String originalDNSCacheTTL = null;</span>
<span class="nc" id="L348">		Boolean allowedToSetTTL = true;</span>
		try {
<span class="nc" id="L350">			originalDNSCacheTTL = java.security.Security</span>
					.getProperty(DNS_CACHE_TTL_PROPERTY_NAME);
			// disable DNS cache
<span class="nc" id="L353">			java.security.Security</span>
					.setProperty(DNS_CACHE_TTL_PROPERTY_NAME, &quot;0&quot;);
<span class="nc" id="L355">		} catch (SecurityException se) {</span>
<span class="nc" id="L356">			allowedToSetTTL = false;</span>
<span class="nc" id="L357">		}</span>

		try {
<span class="nc" id="L360">			return _request(method, url, params, clazz, apiKey);</span>
		} finally {
<span class="nc bnc" id="L362" title="All 4 branches missed.">			if (allowedToSetTTL) {</span>
<span class="nc bnc" id="L363" title="All 4 branches missed.">				if (originalDNSCacheTTL == null) {</span>
					// value unspecified by implementation
<span class="nc" id="L365">					java.security.Security.setProperty(</span>
							DNS_CACHE_TTL_PROPERTY_NAME, &quot;-1&quot;); // cache forever
				} else {
<span class="nc" id="L368">					java.security.Security.setProperty(</span>
							DNS_CACHE_TTL_PROPERTY_NAME, originalDNSCacheTTL);
				}
			}
		}
	}

	protected static &lt;T&gt; T _request(APIResource.RequestMethod method,
			String url, Map&lt;String, Object&gt; params, Class&lt;T&gt; clazz,
			String apiKey) throws AuthenticationException,
			InvalidRequestException, APIConnectionException, 
			APIException {
<span class="nc bnc" id="L380" title="All 8 branches missed.">		if ((Lob.apiKey == null || Lob.apiKey.length() == 0)</span>
				&amp;&amp; (apiKey == null || apiKey.length() == 0)) {
<span class="nc" id="L382">			throw new AuthenticationException(</span>
					&quot;No API key provided. (HINT: set your API key using 'Lob.apiKey = &lt;API-KEY&gt;'. &quot;
							+ &quot;You can generate API keys from the Lob web interface. &quot;
							+ &quot;See https://lob.com/api for details or email support@lob.com if you have questions.&quot;);
		}

<span class="nc bnc" id="L388" title="All 2 branches missed.">		if (apiKey == null) {</span>
<span class="nc" id="L389">			apiKey = Lob.apiKey;</span>
		}

		String query;

		try {
<span class="nc" id="L395">			query = createQuery(params);</span>
<span class="nc" id="L396">		} catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L397">			throw new InvalidRequestException(&quot;Unable to encode parameters to &quot;</span>
					+ CHARSET
					+ &quot;. Please contact support@lob.com for assistance.&quot;,
					null, e);
<span class="nc" id="L401">		}</span>

		LobResponse response;
		try {
			// HTTPSURLConnection verifies SSL cert by default
<span class="nc" id="L406">			response = makeURLConnectionRequest(method, url, query, apiKey, params);</span>
<span class="nc" id="L407">		} catch (ClassCastException ce) {</span>
			// appengine doesn't have HTTPSConnection, use URLFetch API
<span class="nc" id="L409">			String appEngineEnv = System.getProperty(</span>
					&quot;com.google.appengine.runtime.environment&quot;, null);
<span class="nc bnc" id="L411" title="All 2 branches missed.">			if (appEngineEnv != null) {</span>
<span class="nc" id="L412">				response = makeAppEngineRequest(method, url, query, apiKey);</span>
			} else {
				// non-appengine ClassCastException
<span class="nc" id="L415">				throw ce;</span>
			}
<span class="nc" id="L417">		}</span>
<span class="nc" id="L418">		int rCode = response.responseCode;</span>
<span class="nc" id="L419">		String rBody = response.responseBody;</span>
<span class="nc bnc" id="L420" title="All 4 branches missed.">		if (rCode &lt; 200 || rCode &gt;= 300) {</span>
<span class="nc" id="L421">			handleAPIError(rBody, rCode);</span>
		}
<span class="nc" id="L423">		return gson.fromJson(rBody, clazz);</span>
	}

	private static void handleAPIError(String rBody, int rCode)
			throws InvalidRequestException, AuthenticationException,
			APIException {
<span class="nc" id="L429">		APIResource.Error error = gson.fromJson(rBody,</span>
				APIResource.ErrorContainer.class).error;
<span class="nc bnc" id="L431" title="All 4 branches missed.">		switch (rCode) {</span>
		case 400:
<span class="nc" id="L433">			throw new InvalidRequestException(error.message, error.param, null);</span>
		case 404:
<span class="nc" id="L435">			throw new InvalidRequestException(error.message, error.param, null);</span>
		case 401:
<span class="nc" id="L437">			throw new AuthenticationException(error.message);</span>

		default:
<span class="nc" id="L440">			throw new APIException(error.message, null);</span>
		}
	}

	/*
	 * This is slower than usual because of reflection but avoids having to
	 * maintain AppEngine-specific JAR
	 */
	private static LobResponse makeAppEngineRequest(RequestMethod method,
			String url, String query, String apiKey) throws APIException {
<span class="nc" id="L450">		String unknownErrorMessage = &quot;Sorry, an unknown error occurred while trying to use the &quot;</span>
				+ &quot;Google App Engine runtime. Please contact support@lob.com for assistance.&quot;;
		try {
<span class="nc bnc" id="L453" title="All 4 branches missed.">			if (method == RequestMethod.GET || method == RequestMethod.DELETE) {</span>
<span class="nc" id="L454">				url = String.format(&quot;%s?%s&quot;, url, query);</span>
			}
<span class="nc" id="L456">			URL fetchURL = new URL(url);</span>

<span class="nc" id="L458">			Class&lt;?&gt; requestMethodClass = Class</span>
					.forName(&quot;com.google.appengine.api.urlfetch.HTTPMethod&quot;);
<span class="nc" id="L460">			Object httpMethod = requestMethodClass.getDeclaredField(</span>
					method.name()).get(null);

<span class="nc" id="L463">			Class&lt;?&gt; fetchOptionsBuilderClass = Class</span>
					.forName(&quot;com.google.appengine.api.urlfetch.FetchOptions$Builder&quot;);
<span class="nc" id="L465">			Object fetchOptions = null;</span>
			try {
<span class="nc" id="L467">				fetchOptions = fetchOptionsBuilderClass.getDeclaredMethod(</span>
						&quot;validateCertificate&quot;).invoke(null);
<span class="nc" id="L469">			} catch (NoSuchMethodException e) {</span>
<span class="nc" id="L470">				System.err</span>
						.println(&quot;Warning: this App Engine SDK version does not allow verification of SSL certificates;&quot;
								+ &quot;this exposes you to a MITM attack. Please upgrade your App Engine SDK to &gt;=1.5.0. &quot;
								+ &quot;If you have questions, contact support@lob.com.&quot;);
<span class="nc" id="L474">				fetchOptions = fetchOptionsBuilderClass.getDeclaredMethod(</span>
						&quot;withDefaults&quot;).invoke(null);
<span class="nc" id="L476">			}</span>

<span class="nc" id="L478">			Class&lt;?&gt; fetchOptionsClass = Class</span>
					.forName(&quot;com.google.appengine.api.urlfetch.FetchOptions&quot;);

			// GAE requests can time out after 60 seconds, so make sure we leave
			// some time for the application to handle a slow Lob
<span class="nc" id="L483">			fetchOptionsClass.getDeclaredMethod(&quot;setDeadline&quot;,</span>
					java.lang.Double.class)
					.invoke(fetchOptions, new Double(55));

<span class="nc" id="L487">			Class&lt;?&gt; requestClass = Class</span>
					.forName(&quot;com.google.appengine.api.urlfetch.HTTPRequest&quot;);

<span class="nc" id="L490">			Object request = requestClass.getDeclaredConstructor(URL.class,</span>
					requestMethodClass, fetchOptionsClass).newInstance(
					fetchURL, httpMethod, fetchOptions);

<span class="nc bnc" id="L494" title="All 2 branches missed.">			if (method == RequestMethod.POST) {</span>
<span class="nc" id="L495">				requestClass.getDeclaredMethod(&quot;setPayload&quot;, byte[].class)</span>
						.invoke(request, query.getBytes());
			}

<span class="nc bnc" id="L499" title="All 2 branches missed.">			for (Map.Entry&lt;String, String&gt; header : getHeaders(apiKey)</span>
					.entrySet()) {
<span class="nc" id="L501">				Class&lt;?&gt; httpHeaderClass = Class</span>
						.forName(&quot;com.google.appengine.api.urlfetch.HTTPHeader&quot;);
<span class="nc" id="L503">				Object reqHeader = httpHeaderClass.getDeclaredConstructor(</span>
						String.class, String.class).newInstance(
						header.getKey(), header.getValue());
<span class="nc" id="L506">				requestClass.getDeclaredMethod(&quot;setHeader&quot;, httpHeaderClass)</span>
						.invoke(request, reqHeader);
<span class="nc" id="L508">			}</span>

<span class="nc" id="L510">			Class&lt;?&gt; urlFetchFactoryClass = Class</span>
					.forName(&quot;com.google.appengine.api.urlfetch.URLFetchServiceFactory&quot;);
<span class="nc" id="L512">			Object urlFetchService = urlFetchFactoryClass.getDeclaredMethod(</span>
					&quot;getURLFetchService&quot;).invoke(null);

<span class="nc" id="L515">			Method fetchMethod = urlFetchService.getClass().getDeclaredMethod(</span>
					&quot;fetch&quot;, requestClass);
<span class="nc" id="L517">			fetchMethod.setAccessible(true);</span>
<span class="nc" id="L518">			Object response = fetchMethod.invoke(urlFetchService, request);</span>

<span class="nc" id="L520">			int responseCode = (Integer) response.getClass()</span>
					.getDeclaredMethod(&quot;getResponseCode&quot;).invoke(response);
<span class="nc" id="L522">			String body = new String((byte[]) response.getClass()</span>
					.getDeclaredMethod(&quot;getContent&quot;).invoke(response), CHARSET);
<span class="nc" id="L524">			return new LobResponse(responseCode, body);</span>
<span class="nc" id="L525">		} catch (InvocationTargetException e) {</span>
<span class="nc" id="L526">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L527">		} catch (MalformedURLException e) {</span>
<span class="nc" id="L528">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L529">		} catch (NoSuchFieldException e) {</span>
<span class="nc" id="L530">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L531">		} catch (SecurityException e) {</span>
<span class="nc" id="L532">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L533">		} catch (NoSuchMethodException e) {</span>
<span class="nc" id="L534">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L535">		} catch (ClassNotFoundException e) {</span>
<span class="nc" id="L536">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L537">		} catch (IllegalArgumentException e) {</span>
<span class="nc" id="L538">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L539">		} catch (IllegalAccessException e) {</span>
<span class="nc" id="L540">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L541">		} catch (InstantiationException e) {</span>
<span class="nc" id="L542">			throw new APIException(unknownErrorMessage, e);</span>
<span class="nc" id="L543">		} catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L544">			throw new APIException(unknownErrorMessage, e);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>